#!/bin/bash
# Chezmoi run_once script - executes once per machine
# Installs dependencies for the dotfiles to work properly

set -e

echo "ğŸš€ Setting up machine..."

# â”€â”€â”€ Detect OS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

{{ if eq .chezmoi.os "darwin" -}}
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# macOS Setup
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo "ğŸ Detected macOS"

# Install Homebrew if missing
if ! command -v brew &> /dev/null; then
  echo "ğŸ“¦ Installing Homebrew..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  eval "$(/opt/homebrew/bin/brew shellenv)"
fi

# Install everything from Brewfile
echo "ğŸ“¦ Installing from Brewfile..."
brew bundle --global --no-lock

echo "  âœ“ Homebrew packages installed"

{{ else if eq .chezmoi.os "linux" -}}
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Linux Setup
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo "ğŸ§ Detected Linux"

# Detect package manager
if command -v apt &> /dev/null; then
  PKG_MGR="apt"
  INSTALL_CMD="sudo apt install -y"
  UPDATE_CMD="sudo apt update"
elif command -v dnf &> /dev/null; then
  PKG_MGR="dnf"
  INSTALL_CMD="sudo dnf install -y"
  UPDATE_CMD="sudo dnf check-update || true"
elif command -v pacman &> /dev/null; then
  PKG_MGR="pacman"
  INSTALL_CMD="sudo pacman -S --noconfirm"
  UPDATE_CMD="sudo pacman -Sy"
else
  echo "âš ï¸  Unknown package manager, skipping system packages"
  PKG_MGR=""
fi

if [[ -n "$PKG_MGR" ]]; then
  echo "ğŸ“¦ Using $PKG_MGR..."
  $UPDATE_CMD

  # Core tools (package names vary by distro)
  PACKAGES=(fzf bat ripgrep fd-find tree jq direnv)
  
  for pkg in "${PACKAGES[@]}"; do
    echo "  Installing $pkg..."
    $INSTALL_CMD "$pkg" 2>/dev/null || echo "  âš ï¸  $pkg not found in repos"
  done
fi

# Install Starship
if ! command -v starship &> /dev/null; then
  echo "â­ Installing Starship..."
  curl -sS https://starship.rs/install.sh | sh -s -- -y
else
  echo "  âœ“ Starship already installed"
fi

{{ end -}}

# â”€â”€â”€ ZSH Plugins (cross-platform) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

echo "ğŸ”Œ Setting up ZSH plugins..."

ZSH_PLUGIN_DIR="$HOME/.zsh"
mkdir -p "$ZSH_PLUGIN_DIR"

# zsh-syntax-highlighting
if [[ ! -d "$ZSH_PLUGIN_DIR/zsh-syntax-highlighting" ]]; then
  echo "  Installing zsh-syntax-highlighting..."
  git clone --depth 1 https://github.com/zsh-users/zsh-syntax-highlighting.git \
    "$ZSH_PLUGIN_DIR/zsh-syntax-highlighting"
else
  echo "  âœ“ zsh-syntax-highlighting already installed"
fi

# zsh-autosuggestions
if [[ ! -d "$ZSH_PLUGIN_DIR/zsh-autosuggestions" ]]; then
  echo "  Installing zsh-autosuggestions..."
  git clone --depth 1 https://github.com/zsh-users/zsh-autosuggestions.git \
    "$ZSH_PLUGIN_DIR/zsh-autosuggestions"
else
  echo "  âœ“ zsh-autosuggestions already installed"
fi

# zsh-shift-select (IDE-style shift+arrow selection)
if [[ ! -d "$ZSH_PLUGIN_DIR/zsh-shift-select" ]]; then
  echo "  Installing zsh-shift-select..."
  git clone --depth 1 https://github.com/jirutka/zsh-shift-select.git \
    "$ZSH_PLUGIN_DIR/zsh-shift-select"
else
  echo "  âœ“ zsh-shift-select already installed"
fi

# â”€â”€â”€ Done â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

echo ""
echo "âœ… Machine setup complete!"
echo ""
echo "Next steps:"
echo "  1. Restart your terminal (or run: exec zsh)"
echo "  2. If fonts look wrong in Ghostty, check font-family in ~/.config/ghostty/config"
echo ""
